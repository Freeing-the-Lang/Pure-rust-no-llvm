name: "ğŸ—ï¸ Pure-Rust-No-LLVM â€” 3OS Build & ProofLedger Release"

on:
  push:
    branches: [ main ]
  pull_request:
    types: [ closed ]
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"

permissions:
  contents: write

concurrency:
  group: pure-rust-no-llvm-3os-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-3os:
    name: "ğŸ§© Build on ${{ matrix.os }}"
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: "ğŸ§­ Checkout Repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "âš™ï¸ Setup Environment (Linux/macOS)"
        if: runner.os != 'Windows'
        run: |
          sudo apt update || true
          sudo apt install -y python3 g++ nasm || true
          chmod +x build_to_nasm.sh

      - name: "âš™ï¸ Setup Environment (Windows)"
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          choco install python --pre -y
          choco install mingw nasm -y
          git config --global core.autocrlf false

      - name: "ğŸš€ Run Full Chain Build"
        shell: bash
        run: ./build_to_nasm.sh

      - name: "ğŸª¶ Generate ProofLedger"
        shell: bash
        run: |
          sha256sum out.cpp out.asm out > proofledger.txt 2>/dev/null || certutil -hashfile out SHA256 > proofledger.txt
          echo "Generated on $(date -u)" >> proofledger.txt
          echo "Runner: $RUNNER_OS" >> proofledger.txt
          echo "Commit: $GITHUB_SHA" >> proofledger.txt
          cat proofledger.txt

      - name: "ğŸ“¦ Upload Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: "artifacts-${{ runner.os }}"
          path: |
            out
            out.cpp
            out.asm
            proofledger.txt
          if-no-files-found: ignore

  release:
    name: "ğŸ·ï¸ Create Multi-OS Release"
    runs-on: ubuntu-latest
    needs: build-3os
    steps:
      - name: "ğŸ“¥ Download All Artifacts"
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: "ğŸ·ï¸ Create GitHub Release"
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.run_number }}
          name: "Pure-Rust-No-LLVM 3OS Build #${{ github.run_number }}"
          body: |
            ğŸ§© **Pure-Rust-No-LLVM â€” 3OS Build Chain**

            âœ… Rust â†’ C++ â†’ NASM â†’ Binary  
            âœ… ProofLedger Generated on 3 Platforms  
            âœ… Deterministic Multi-OS Chain

            Commit: ${{ github.sha }}
          files: dist/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
