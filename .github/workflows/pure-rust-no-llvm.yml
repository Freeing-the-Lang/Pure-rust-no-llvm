name: "ğŸ—ï¸ Pure-Rust-No-LLVM â€” C++ Transpile â†’ NASM â†’ Executable (LLVM-Free Full Chain)"

on:
  push:
    branches: [ "*" ]
  pull_request:
    types: [ opened, reopened, synchronize, closed ]
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"

permissions:
  contents: write

concurrency:
  group: pure-rust-no-llvm-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-3os:
    name: "ğŸ§© LLVM-Free Chain Build on ${{ matrix.os }} â€” Branch ${{ github.ref_name }}"
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: "ğŸ§­ Checkout Repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Environment Setup
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "âš™ï¸ Setup Build Environment (Linux/macOS)"
        if: runner.os != 'Windows'
        shell: bash
        run: |
          echo "âš™ï¸ Installing Python + C++ + NASM for $RUNNER_OS..."
          sudo apt update || true
          sudo apt install -y python3 g++ nasm || true
          mkdir -p output
          chmod +x build_to_nasm.sh

      - name: "âš™ï¸ Setup Build Environment (Windows)"
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          echo "âš™ï¸ Preparing Windows build environment..."
          choco upgrade chocolatey -y
          choco install python -y --no-progress
          choco install mingw -y --no-progress
          choco install nasm -y --no-progress
          python --version
          g++ --version
          nasm -v
          mkdir output
          git config --global core.autocrlf false

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Build Chain Execution
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "ğŸ¦€ Transpile Rust â†’ C++ (Python script)"
        shell: bash
        run: |
          echo "ğŸ¦€ Transpiling Rust source â†’ C++..."
          python3 transpile_rust_to_cpp.py
          ls -l out.cpp || echo "âš ï¸ No out.cpp generated."

      - name: "âš™ï¸ Convert C++ â†’ NASM Assembly"
        shell: bash
        run: |
          echo "âš™ï¸ Building C++ â†’ ASM using g++..."
          g++ -S -masm=intel out.cpp -o out.asm || true
          ls -l out.asm || echo "âš ï¸ Assembly not generated."

      - name: "ğŸ—ï¸ Assemble NASM â†’ Executable"
        shell: bash
        run: |
          echo "ğŸ—ï¸ Assembling NASM output â†’ Executable..."
          if [ "$RUNNER_OS" = "Windows" ]; then
            nasm -f win64 out.asm -o out.obj
            g++ out.obj -o output/out.exe
          else
            nasm -f elf64 out.asm -o out.o
            g++ out.o -o output/out
          fi
          echo "âœ… Executable generated in output/"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ProofLedger
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "ğŸ§¾ Generate ProofLedger"
        shell: bash
        run: |
          echo "ğŸ§¾ Generating ProofLedger..."
          cd output
          if command -v sha256sum >/dev/null 2>&1; then
            sha256sum * > proofledger.txt
          else
            certutil -hashfile out.exe SHA256 > proofledger.txt
          fi
          echo "Generated on $(date -u)" >> proofledger.txt
          echo "Runner: $RUNNER_OS" >> proofledger.txt
          echo "Branch: $GITHUB_REF_NAME" >> proofledger.txt
          echo "Commit: $GITHUB_SHA" >> proofledger.txt
          cat proofledger.txt

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Artifact Upload
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "ğŸ“¦ Upload Build Outputs"
        uses: actions/upload-artifact@v4
        with:
          name: "pure-rust-no-llvm-${{ runner.os }}-${{ github.ref_name }}"
          path: output/
          if-no-files-found: error

  release:
    name: "ğŸ·ï¸ Multi-OS LLVM-Free Release"
    runs-on: ubuntu-latest
    needs: build-3os
    steps:
      - name: "ğŸ“¥ Download All Artifacts"
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: "ğŸ·ï¸ Create GitHub Release"
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.run_number }}-${{ github.ref_name }}
          name: "Pure-Rust-No-LLVM Build #${{ github.run_number }} â€” Branch: ${{ github.ref_name }}"
          body: |
            ğŸ§© **Pure-Rust-No-LLVM â€” LLVM-Free Chain (Rust â†’ C++ â†’ NASM â†’ Executable)**  

            âœ… LLVM-Free Full Deterministic Chain  
            âœ… Rust Reinterpreted via C++  
            âœ… NASM Assembly + Executable Output  
            âœ… ProofLedger Hash Verification  
            âœ… Cross-Platform: Linux / macOS / Windows  

            **Branch:** ${{ github.ref_name }}  
            **Commit:** ${{ github.sha }}
          files: dist/**
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
