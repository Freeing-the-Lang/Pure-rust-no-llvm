name: "ğŸ—ï¸ Pure-Rust-No-LLVM â€” Rustâ†’C++â†’NASM Build & ProofLedger Release"

on:
  push:
    branches: [ main ]
  pull_request:
    types: [ closed ]
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"  # ë§¤ì¼ ìƒˆë²½ 3ì‹œ ìë™ ë¹Œë“œ

permissions:
  contents: write

concurrency:
  group: pure-rust-no-llvm-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-chain:
    runs-on: ubuntu-latest

    steps:
      - name: "ğŸ§­ Checkout Repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "âš™ï¸ Setup Environment"
        run: |
          sudo apt update
          sudo apt install -y python3 g++ nasm

      - name: "ğŸ”§ Make Scripts Executable"
        run: chmod +x build_to_nasm.sh

      - name: "ğŸš€ Run Full Chain Build"
        run: ./build_to_nasm.sh

      - name: "ğŸª¶ Generate ProofLedger"
        run: |
          sha256sum out.cpp out.asm out > proofledger.txt
          echo "Generated on $(date -u)" >> proofledger.txt
          echo "Commit: $GITHUB_SHA" >> proofledger.txt
          echo "âœ… ProofLedger created."
          cat proofledger.txt

      - name: "ğŸ§¾ Commit & Push ProofLedger"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add proofledger.txt
          git commit -m "ğŸª¶ Update ProofLedger ($(date -u +'%Y-%m-%d %H:%M:%S'))" || echo "No changes"
          git push

      - name: "ğŸ“¦ Upload Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: "pure-rust-no-llvm-artifacts"
          path: |
            out.cpp
            out.asm
            out
            proofledger.txt
          if-no-files-found: ignore

      - name: "ğŸ·ï¸ Auto Release"
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.run_number }}
          name: "Pure-Rust-No-LLVM Build #${{ github.run_number }}"
          body: |
            ğŸ§© **Pure-Rust-No-LLVM** Full Build Chain Result  
            - Rust â†’ C++ â†’ NASM â†’ Binary  
            - Auto ProofLedger Generated  
            - SHA256 Verified Build Chain  

            Commit: ${{ github.sha }}
          files: |
            out
            out.cpp
            out.asm
            proofledger.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
