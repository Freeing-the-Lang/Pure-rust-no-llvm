name: "üèóÔ∏è Pure-Rust-No-LLVM ‚Äî 3OS Build & ProofLedger Release (Branch-Aware)"

on:
  push:        # ‚úÖ Î™®Îì† Î∏åÎûúÏπòÏóê ÎåÄÌï¥ ÏûêÎèô Ïã§Ìñâ
    branches: [ "*" ]
  pull_request:
    types: [ opened, reopened, synchronize, closed ]
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"

permissions:
  contents: write

concurrency:
  group: pure-rust-no-llvm-3os-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-3os:
    name: "üß© Build on ${{ matrix.os }} ‚Äî Branch ${{ github.ref_name }}"
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: "üß≠ Checkout Repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "‚öôÔ∏è Setup Environment (Linux/macOS)"
        if: runner.os != 'Windows'
        run: |
          sudo apt update || true
          sudo apt install -y python3 g++ nasm || true
          chmod +x build_to_nasm.sh

      - name: "‚öôÔ∏è Setup Environment (Windows)"
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          choco install python --pre -y
          choco install mingw nasm -y
          git config --global core.autocrlf false

      - name: "üöÄ Run Full Chain Build"
        shell: bash
        run: ./build_to_nasm.sh

      - name: "ü™∂ Generate ProofLedger"
        shell: bash
        run: |
          if command -v sha256sum >/dev/null 2>&1; then
            sha256sum out.cpp out.asm out > proofledger.txt
          else
            certutil -hashfile out SHA256 > proofledger.txt
          fi
          echo "Generated on $(date -u)" >> proofledger.txt
          echo "Runner: $RUNNER_OS" >> proofledger.txt
          echo "Branch: $GITHUB_REF_NAME" >> proofledger.txt
          echo "Commit: $GITHUB_SHA" >> proofledger.txt
          cat proofledger.txt

      - name: "üì¶ Rename Outputs with OS + Branch Suffix"
        shell: bash
        run: |
          OS_NAME=$(echo "${RUNNER_OS}" | tr '[:upper:]' '[:lower:]')
          BRANCH_NAME=$(echo "${GITHUB_REF_NAME}" | tr '/' '-' | tr '[:upper:]' '[:lower:]')
          mv out "out-${OS_NAME}-${BRANCH_NAME}" || true
          mv out.cpp "out-${OS_NAME}-${BRANCH_NAME}.cpp" || true
          mv out.asm "out-${OS_NAME}-${BRANCH_NAME}.asm" || true
          mv proofledger.txt "proofledger-${OS_NAME}-${BRANCH_NAME}.txt" || true

      - name: "üì§ Upload OS+Branch Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: "artifacts-${{ runner.os }}-${{ github.ref_name }}"
          path: |
            out-*
            proofledger-*.txt
          if-no-files-found: ignore

  release:
    name: "üè∑Ô∏è Create Multi-OS Release (Branch-Aware)"
    runs-on: ubuntu-latest
    needs: build-3os
    steps:
      - name: "üì• Download All Artifacts"
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: "üè∑Ô∏è Create GitHub Release"
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.run_number }}-${{ github.ref_name }}
          name: "Pure-Rust-No-LLVM 3OS Build #${{ github.run_number }} ‚Äî Branch: ${{ github.ref_name }}"
          body: |
            üß© **Pure-Rust-No-LLVM ‚Äî 3OS Build Chain (Branch Aware)**

            ‚úÖ Rust ‚Üí C++ ‚Üí NASM ‚Üí Binary  
            ‚úÖ ProofLedger Generated per OS  
            ‚úÖ Deterministic Multi-Platform Chain  
            ‚úÖ Auto Release with SHA256 Verification  

            **Branch:** ${{ github.ref_name }}  
            **Commit:** ${{ github.sha }}
          files: dist/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
